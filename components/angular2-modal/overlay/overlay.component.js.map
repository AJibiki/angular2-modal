{"version":3,"file":"overlay.component.js","sourceRoot":"","sources":["overlay.component.ts"],"names":[],"mappings":"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","sourcesContent":["declare const clearTimeout: any;\n\nimport {\n  Component,\n  ComponentRef,\n  ElementRef,\n  ResolvedReflectiveProvider,\n  ViewChild,\n  ViewContainerRef,\n  ViewEncapsulation\n} from '@angular/core';\n\nimport { DomSanitizationService } from '@angular/platform-browser';\n\nimport { PromiseCompleter, supportsKey } from '../framework/utils';\nimport { DialogRef } from '../models/dialog-ref';\nimport { BaseDynamicComponent } from '../components';\n\n\n/**\n * Represents the modal overlay.\n */\n@Component({\n  selector: 'modal-overlay',\n  host: {\n    '[attr.style]': 'styleStr',\n    '[attr.class]': 'cssClass',\n    '(body:keydown)': 'documentKeypress($event)'\n  },\n  encapsulation: ViewEncapsulation.None,\n  template: `<span #vcRef></span>`\n})\nexport class ModalOverlay extends BaseDynamicComponent {\n  private beforeDestroyHandlers: Array<() => Promise<void>>;\n  @ViewChild('vcRef', {read: ViewContainerRef}) private vcRef: ViewContainerRef;\n  \n  constructor(private dialogRef: DialogRef<any>,\n              el: ElementRef,\n              sanitizer: DomSanitizationService) {\n    super(sanitizer, el);\n    this.activateAnimationListener();\n  }\n\n  addComponent<T>(type: any, bindings?: ResolvedReflectiveProvider[]): ComponentRef<T> {\n    return super._addComponent<T>(type, this.vcRef, bindings);\n  }\n\n  fullscreen(): void {\n    this.style = {\n      position: 'fixed',\n      top: 0,\n      left: 0,\n      bottom: 0,\n      right: 0,\n      'z-index': 1500\n    } as any;\n    this.applyStyle();\n  }\n  \n  insideElement(): void {\n    this.style = {\n      position: 'absolute',\n      width: '100%',\n      height: '100%',\n      top: 0,\n      left: 0,\n      bottom: 0,\n      right: 0\n    } as any;\n    this.applyStyle();\n  }\n\n  /**\n   * Define an element that click inside it will not trigger modal close.\n   * Since events bubble, clicking on a dialog will bubble up to the overlay, a plugin\n   * must define an element that represent the dialog, the overlay will make sure no to close when\n   * it was clicked.\n   * @param element\n   */\n  setClickBoundary(element: Element): void {\n    let target: Element;\n    const elListener = event => target = event.target as any;\n    const docListener = event => {\n      if (this.dialogRef.context.isBlocking || !this.dialogRef.overlay.isTopMost(this.dialogRef) ) {\n        return;\n      }\n\n      let current: any = event.target;\n\n      // on click, this will hit.\n      if (current === target) return;\n\n      // on mouse down -> drag -> release the current might not be 'target', it might be\n      // a sibling or a child (i.e: not part of the tree-up direction). It might also be a release\n      // outside the dialog... so we compare to the boundary element\n      do {\n        if (current === element) {\n          return;\n        }\n      } while (current.parentNode && ( current = current.parentNode ));\n      this.dialogRef.dismiss();\n    };\n\n    this.dialogRef.onDestroy.subscribe(() => {\n      element.removeEventListener('click', elListener, false);\n      element.removeEventListener('touchstart', elListener, false);\n      document.removeEventListener('click', docListener, false);\n      document.removeEventListener('touchend', docListener, false);\n    });\n\n\n    setTimeout(() => {\n      element.addEventListener('mousedown', elListener, false);\n      element.addEventListener('touchstart', docListener, false);\n      document.addEventListener('click', docListener, false);\n      document.addEventListener('touchend', docListener, false);\n    });\n  }\n\n  /**\n   * Temp workaround for animation where destruction of the top level component does not\n   * trigger child animations. Solution should be found either in animation module or in design\n   * of the modal component tree.\n   * @returns {Promise<void>}\n   */\n  canDestroy(): Promise<void> {\n    const completer = new PromiseCompleter<void>();\n\n    if (!Array.isArray(this.beforeDestroyHandlers)) {\n      completer.resolve();\n    } else {\n\n      // run destroy notification but protect against halt.\n      let id = setTimeout(() => {\n        id = null;\n        completer.reject();\n      }, 1000);\n\n      const resolve = () => {\n        if (id === null) return;\n\n        clearTimeout(id);\n        completer.resolve();\n      };\n\n      Promise.all(this.beforeDestroyHandlers.map( fn => fn() ))\n        .then(resolve)\n        .catch(resolve);\n\n    }\n\n    return completer.promise;\n  }\n\n  /**\n   * A handler running before destruction of the overlay\n   * use to delay destruction due to animation.\n   * This is part of the workaround for animation, see canDestroy.\n   * \n   * NOTE: There is no guarantee that the listeners will fire, use dialog.onDestory for that.\n   * @param fn\n   */\n  beforeDestroy(fn: () => Promise<void>) {\n    if (!this.beforeDestroyHandlers) {\n      this.beforeDestroyHandlers = [];\n    }\n    this.beforeDestroyHandlers.push(fn);\n  }\n  \n  documentKeypress(event: KeyboardEvent) {\n    // check that this modal is the last in the stack.\n    if (!this.dialogRef.overlay.isTopMost(this.dialogRef)) return;\n\n\n    if (supportsKey(event.keyCode, <any>this.dialogRef.context.keyboard)) {\n      this.dialogRef.dismiss();\n    }\n  }\n\n  ngOnDestroy(): void {\n    super.ngOnDestroy();\n    if (this.dialogRef.destroyed !== true) {\n      // if we're here the overlay is destroyed by an external event that is not user invoked.\n      // i.e: The user did no call dismiss or close and dialogRef.destroy() did not invoke.\n      // this will happen when routing or killing an element containing a blocked overlay (ngIf)\n      // we bail out, i.e gracefully shutting down.\n      this.dialogRef.bailOut();\n    }\n  }\n}\n"]}